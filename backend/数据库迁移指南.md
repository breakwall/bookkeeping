# 数据库迁移指南：添加term字段

## 迁移说明
为 `deposits` 表添加 `term` 字段（存期，整数年，可为null）

## 自动迁移（推荐）

### 方式1：直接重启后端
当前配置使用 JPA 的 `ddl-auto: update`，会自动处理表结构变更。

**操作步骤：**
1. 停止正在运行的后端服务
2. 重新启动后端：
   ```bash
   cd backend
   mvn spring-boot:run
   ```
3. 查看启动日志，应该能看到 Hibernate 自动执行的 ALTER TABLE 语句

### 验证迁移是否成功

**方法1：查看日志**
启动时应该能看到类似以下的SQL语句：
```
Hibernate: alter table deposits add column term integer
```

**方法2：使用SQLite命令行工具验证**
```bash
# 进入数据库文件所在目录
cd backend/data

# 使用SQLite命令行工具（需要安装SQLite）
sqlite3 bookkeeping.db

# 查看deposits表结构
.schema deposits

# 或者查看表信息
PRAGMA table_info(deposits);

# 应该能看到term字段：
# cid | name | type | notnull | dflt_value | pk
# ... | term | INTEGER | 0 | NULL | 0

# 退出
.exit
```

**方法3：使用Java代码验证**
可以运行以下查询验证：
```java
// 在现有的QueryUsersTest中添加测试方法
@Test
public void testTermFieldExists() {
    String sql = "PRAGMA table_info(deposits)";
    // 执行查询，检查term字段是否存在
}
```

## 手动迁移（备选）

如果自动迁移失败，可以手动执行SQL：

### 方法1：使用SQLite命令行工具

```bash
# 进入数据库文件所在目录
cd backend/data

# 打开SQLite命令行
sqlite3 bookkeeping.db

# 执行迁移SQL
ALTER TABLE deposits ADD COLUMN term INTEGER;

# 验证
PRAGMA table_info(deposits);

# 退出
.exit
```

### 方法2：使用SQLite管理工具

使用图形化工具（如 DB Browser for SQLite、DBeaver 等）：
1. 打开 `backend/data/bookkeeping.db`
2. 执行SQL：
   ```sql
   ALTER TABLE deposits ADD COLUMN term INTEGER;
   ```
3. 提交更改

### 方法3：通过后端代码执行

如果需要在应用启动时确保迁移完成，可以创建一个配置类：

```java
@Configuration
public class MigrationConfig {
    
    @Autowired
    private DataSource dataSource;
    
    @PostConstruct
    public void migrate() {
        try (Connection conn = dataSource.getConnection()) {
            // 检查term字段是否存在
            DatabaseMetaData metaData = conn.getMetaData();
            ResultSet columns = metaData.getColumns(null, null, "deposits", "term");
            
            if (!columns.next()) {
                // 字段不存在，执行添加
                try (Statement stmt = conn.createStatement()) {
                    stmt.execute("ALTER TABLE deposits ADD COLUMN term INTEGER");
                    System.out.println("term字段已成功添加");
                }
            } else {
                System.out.println("term字段已存在");
            }
        } catch (SQLException e) {
            System.err.println("迁移失败: " + e.getMessage());
            // 注意：如果字段已存在，会抛出异常，这是正常的
            if (!e.getMessage().contains("duplicate column")) {
                e.printStackTrace();
            }
        }
    }
}
```

## 注意事项

1. **备份数据库**（重要！）
   在执行任何迁移前，建议先备份数据库：
   ```bash
   cp backend/data/bookkeeping.db backend/data/bookkeeping.db.backup
   ```

2. **SQLite限制**
   - SQLite 的 `ALTER TABLE` 不支持 `IF NOT EXISTS`
   - 如果字段已存在，再次执行 `ALTER TABLE ADD COLUMN` 会报错，但这不影响数据

3. **数据兼容性**
   - 新添加的 `term` 字段默认值为 `NULL`
   - 已有的存款记录，`term` 字段为 `NULL` 是正常的（符合预期）
   - 只有新创建的"定期"存款记录才需要填写 `term`

4. **验证迁移**
   迁移成功后，可以：
   - 在前端创建一条"定期"存款记录，验证存期字段是否正常保存
   - 检查数据库中该记录的 `term` 字段是否有值

## 回滚（如果需要）

SQLite 不支持直接删除列，如果需要回滚，需要：
1. 创建新表（不含term字段）
2. 复制数据（排除term字段）
3. 删除旧表
4. 重命名新表

但通常不需要回滚，因为 `term` 字段为可选字段，不影响现有功能。

## 故障排除

### 问题1：启动时没有看到 ALTER TABLE 语句
- **可能原因**：字段已经存在
- **解决方法**：使用验证方法2或3检查字段是否已存在

### 问题2：手动执行 ALTER TABLE 时报错 "duplicate column name: term"
- **原因**：字段已存在
- **解决方法**：这是正常的，说明迁移已完成，无需再次执行

### 问题3：启动后仍然报错
- **检查**：确保实体类 `Deposit.java` 中的 `term` 字段已正确添加
- **检查**：确保 `application.yml` 中 `ddl-auto: update` 配置正确
- **解决方法**：查看详细错误日志，根据错误信息处理
