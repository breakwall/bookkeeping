version: '3.8'

services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: bookkeeping-backend
    restart: unless-stopped
    ports:
      - "8080:8080"
    volumes:
      # 数据持久化：数据库文件
      - ./backend/data:/app/data
      # 日志持久化
      - ./backend/logs:/app/logs
    environment:
      # 时区设置（UTC+8，中国时区）
      - TZ=Asia/Shanghai
      # 生产环境 JWT 密钥（必须修改！）
      - JWT_SECRET=${JWT_SECRET:-change-this-in-production}
      - JWT_EXPIRATION=86400000
      # CORS 允许的来源（多个用逗号分隔，例如：http://your-nas-ip,http://your-domain.com）
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-http://localhost}
      # 数据库路径
      - SPRING_DATASOURCE_URL=jdbc:sqlite:/app/data/bookkeeping.db
      # 日志配置
      - LOGGING_FILE_NAME=/app/logs/bookkeeping-backend.log
      # Spring Profile
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-prod}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s  # 增加启动等待时间，因为应用启动需要时间
    networks:
      - bookkeeping-network

  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    container_name: bookkeeping-frontend
    restart: unless-stopped
    ports:
      - "8888:80"  # 外部端口 8888 映射到容器内部 80 端口
    environment:
      # 时区设置（UTC+8，中国时区）
      - TZ=Asia/Shanghai
    depends_on:
      - backend
    # volumes:
      # 如果需要自定义 Nginx 配置，可以挂载
      # - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - bookkeeping-network

networks:
  bookkeeping-network:
    driver: bridge

# volumes:
  # 如果需要使用命名卷而不是绑定挂载，可以取消注释
  # bookkeeping-data:
  # bookkeeping-logs:
